<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ehsaas Sleep Feature</title>
  <style>
    :root {
      --primary-color: #8D64BC;
      --secondary-color: #65b7ea;
      --accent-color: #2f0e21;
      --background-color: #F8F9FA;
      --card-bg: #FFFFFF;
      --text-color: #333333;
      --text-light: #6C757D;
      
      --night-primary-color: #59407A;
      --night-secondary-color: #2f0cbc;
      --night-accent-color: #7053A0;
      --night-background-color: #121212;
      --night-card-bg: #1E1E1E;
      --night-text-color: #E0E0E0;
      --night-text-light: #B0B0B0;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: var(--background-color);
      color: var(--text-color);
      transition: all 0.5s ease;
    }
    /* Lumen-inspired color scheme */
:root {
    --lumen-primary: #5E56E8;
    --lumen-secondary: #7B73FF;
    --lumen-accent: #FF6B6B;
    --lumen-light: #F8F7FF;
    --lumen-dark: #2E2A5C;
    --lumen-text: #4A4A4A;
}

/* Navbar Styles */
.navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 5%;
    background-color: white;
    box-shadow: 0 2px 15px rgba(94, 86, 232, 0.1);
    z-index: 1000;
    transition: all 0.3s ease;
}

.navbar:hover {
    box-shadow: 0 5px 25px rgba(94, 86, 232, 0.15);
}

.logo {
    font-size: 28px;
    font-weight: 700;
    color: var(--lumen-primary);
    text-decoration: none;
    display: flex;
    align-items: center;
}

.logo span {
    color: var(--lumen-accent);
}

.nav-links {
    display: flex;
    gap: 30px;
}

.nav-links a {
    position: relative;
    text-decoration: none;
    color: var(--lumen-text);
    font-weight: 500;
    font-size: 16px;
    transition: all 0.3s ease;
    padding: 5px 0;
}

/* Unique hover effect */
.nav-links a::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: var(--lumen-primary);
    transition: width 0.3s ease;
}

.nav-links a:hover {
    color: var(--lumen-primary);
}

.nav-links a:hover::before {
    width: 100%;
}

/* Button styles */
.auth-buttons {
    display: flex;
    gap: 15px;
}

.nav-btn {
    padding: 10px 22px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.login-btn {
    background: transparent;
    border: 1px solid var(--lumen-primary);
    color: var(--lumen-primary);
}

.login-btn:hover {
    background: rgba(94, 86, 232, 0.05);
}

.signup-btn {
    background: var(--lumen-primary);
    border: 1px solid var(--lumen-primary);
    color: white;
}

.signup-btn:hover {
    background: var(--lumen-secondary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(94, 86, 232, 0.2);
}

/* Mobile menu (hidden by default) */
.mobile-menu-btn {
    display: none;
    background: none;
    border: none;
    font-size: 24px;
    color: var(--lumen-primary);
    cursor: pointer;
}

@media (max-width: 768px) {
    .nav-links, .auth-buttons {
        display: none;
    }
    
    .mobile-menu-btn {
        display: block;
    }
    
    .navbar {
        padding: 15px 5%;
    }
}
    .night-mode {
      background-color: var(--night-background-color);
      color: var(--night-text-color);
    }
    
    .container {
      max-width: 100%;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }
    
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 250px;
      background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 20px;
      display: flex;
      flex-direction: column;
      transition: all 0.5s ease;
      z-index: 100;
    }
    
    .night-mode .sidebar {
      background: linear-gradient(to bottom, var(--night-primary-color), var(--night-secondary-color));
    }
    
    
    .logo {
        font-size: 28px;
        font-weight: 700;
        color: var(--lumen-primary);
        text-decoration: none;
        display: flex;
        align-items: center;
      }

      .logo span {
        color: var(--lumen-accent);
      }

    
    .menu-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 5px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .menu-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .menu-item.active {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    .menu-icon {
      margin-right: 15px;
      width: 20px;
      height: 20px;
    }
    
    .main-content {
      margin-left: 250px;
      padding: 30px;
      transition: all 0.5s ease;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .page-title {
      font-size: 28px;
      font-weight: 600;
      color: var(--primary-color);
      transition: color 0.5s ease;
    }
    
    .night-mode .page-title {
      color: var(--night-accent-color);
    }
    
    .toggle-container {
      display: flex;
      align-items: center;
    }
    
    .toggle-label {
      margin-right: 10px;
      font-weight: 500;
    }
    
    .toggle {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }
    
    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 30px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: var(--accent-color);
    }
    
    .night-mode input:checked + .slider {
      background-color: var(--night-accent-color);
    }
    
    input:checked + .slider:before {
      transform: translateX(30px);
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      transition: all 0.5s ease;
    }
    
    .night-mode .stat-card {
      background: var(--night-card-bg);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .stat-title {
      font-size: 16px;
      color: var(--text-light);
      font-weight: 500;
      transition: color 0.5s ease;
    }
    
    .night-mode .stat-title {
      color: var(--night-text-light);
    }
    
    .stat-icon {
      width: 40px;
      height: 40px;
      background-color: rgba(141, 100, 188, 0.1);
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background-color 0.5s ease;
    }
    
    .night-mode .stat-icon {
      background-color: rgba(112, 83, 160, 0.2);
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--primary-color);
      margin: 10px 0;
      transition: color 0.5s ease;
    }
    
    .night-mode .stat-value {
      color: var(--night-accent-color);
    }
    
    .stat-description {
      font-size: 14px;
      color: var(--text-light);
      transition: color 0.5s ease;
    }
    
    .night-mode .stat-description {
      color: var(--night-text-light);
    }
    
    .progress-container {
      margin-top: 10px;
      height: 8px;
      background-color: #f0f0f0;
      border-radius: 4px;
      overflow: hidden;
      transition: background-color 0.5s ease;
    }
    
    .night-mode .progress-container {
      background-color: #2a2a2a;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(to right, var(--primary-color), var(--accent-color));
      border-radius: 4px;
      transition: width 0.5s ease, background 0.5s ease;
    }
    
    .night-mode .progress-bar {
      background: linear-gradient(to right, var(--night-primary-color), var(--night-accent-color));
    }
    
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      margin-bottom: 30px;
      transition: all 0.5s ease;
    }
    
    .night-mode .card {
      background: var(--night-card-bg);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .card-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--primary-color);
      transition: color 0.5s ease;
    }
    
    .night-mode .card-title {
      color: var(--night-accent-color);
    }
    
    .card-action {
      color: var(--accent-color);
      font-weight: 500;
      cursor: pointer;
      transition: color 0.5s ease;
    }
    
    .night-mode .card-action {
      color: var(--night-accent-color);
    }
    
    .recommendation-item {
      margin-bottom: 20px;
      padding: 15px;
      border-radius: 8px;
      background-color: rgba(141, 100, 188, 0.05);
      border-left: 4px solid var(--accent-color);
      transition: all 0.5s ease;
    }
    
    .night-mode .recommendation-item {
      background-color: rgba(112, 83, 160, 0.1);
      border-left: 4px solid var(--night-accent-color);
    }
    
    .recommendation-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-color);
      transition: color 0.5s ease;
    }
    
    .night-mode .recommendation-title {
      color: var(--night-text-color);
    }
    
    .recommendation-description {
      font-size: 14px;
      color: var(--text-light);
      transition: color 0.5s ease;
    }
    
    .night-mode .recommendation-description {
      color: var(--night-text-light);
    }
    
    .button {
      background: linear-gradient(to right, var(--primary-color), var(--accent-color));
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(141, 100, 188, 0.2);
    }
    
    .night-mode .button {
      background: linear-gradient(to right, var(--night-primary-color), var(--night-accent-color));
      box-shadow: 0 4px 10px rgba(112, 83, 160, 0.3);
    }
    
    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(141, 100, 188, 0.3);
    }
    
    .night-mode .button:hover {
      box-shadow: 0 6px 15px rgba(112, 83, 160, 0.4);
    }
    
    .sun-animation {
      position: absolute;
      top: 60px;
      right: -150px;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(to right, #FFD700, #FFA500);
      box-shadow: 0 0 40px rgba(255, 215, 0, 0.6);
      transition: all 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 10;
    }
    
    .sun-visible {
      right: 50px;
    }
    
    .sun-rays {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      animation: rotate 20s linear infinite;
    }
    
    @keyframes rotate {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }
    
    .ray {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 2px;
      height: 60px;
      background: rgba(255, 215, 0, 0.6);
      transform-origin: bottom center;
    }
    
    .moon {
      position: absolute;
      top: 60px;
      right: -150px;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(to right, #E0E0E0, #BBBBBB);
      box-shadow: 0 0 30px rgba(224, 224, 224, 0.5);
      transition: all 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 10;
    }
    
    .moon-visible {
      right: 60px;
    }
    
    .moon-crater {
      position: absolute;
      background: rgba(200, 200, 200, 0.8);
      border-radius: 50%;
    }
    
    .sleep-chart {
      width: 100%;
      height: 250px;
      margin: 20px 0;
    }
    
    .sleep-schedule {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    
    .schedule-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .day {
      font-weight: 500;
      margin-bottom: 10px;
      color: var(--text-light);
      transition: color 0.5s ease;
    }
    
    .night-mode .day {
      color: var(--night-text-light);
    }
    
    .time-pill {
      background-color: rgba(141, 100, 188, 0.1);
      border-radius: 15px;
      padding: 5px 10px;
      font-size: 12px;
      font-weight: 500;
      color: var(--primary-color);
      transition: all 0.5s ease;
    }
    
    .night-mode .time-pill {
      background-color: rgba(112, 83, 160, 0.2);
      color: var(--night-accent-color);
    }
    
    .stars {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0;
      transition: opacity 1.5s ease;
      z-index: 5;
    }
    
    .night-mode .stars {
      opacity: 1;
    }
    
    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background-color: #fff;
      border-radius: 50%;
      animation: twinkle 5s infinite;
    }
    
    @keyframes twinkle {
      0% { opacity: 0.2; }
      50% { opacity: 1; }
      100% { opacity: 0.2; }
    }
  </style>
</head>

<body>
  <div class="container" id="container">
    <div class="stars" id="stars"></div>
    <div class="sun-animation" id="sun">
      <div class="sun-rays" id="sunRays"></div>
    </div>
    <div class="moon" id="moon">
      <div class="moon-crater" style="width: 15px; height: 15px; top: 15px; left: 20px;"></div>
      <div class="moon-crater" style="width: 10px; height: 10px; top: 45px; left: 50px;"></div>
      <div class="moon-crater" style="width: 20px; height: 20px; top: 30px; left: 40px;"></div>
    </div>
    <nav class="navbar">
        <a href="./index.html" class="logo">Ehsaas<span>.</span></a>
        
        <button class="mobile-menu-btn">â˜°</button>
        
        <div class="nav-links" id="navLinks">
        <a href="mood.html">MOOD AI</a>
        <a href="sleep.html">SLEEP WELL</a>
        <a href="stress.html">DESTRESS</a>
        <a href="./saathi.html">SAATHI ROOMS</a>
        <a href="x.html">CHILL ZONE</a>
        <a href="find_my_therapist.html">NEED HELP?</a>
        <a href="ecom.html">MIND MART</a>
        <a href="sleeptrack.html">SLEEP TRACK</a>
    </div>
    
    <!-- Added id "authButtons" to allow JS targeting -->
    <div class="auth-buttons" id="authButtons">
        <button class="nav-btn login-btn" id="loginBtn" onclick="window.location.href='login.html'">Log in</button>
        <button class="nav-btn signup-btn" id="signupBtn" onclick="window.location.href='signup.html'">Get Started</button>
        <a href="welcome_board.html"><button class="nav-btn signup-btn" id="dashboard">Dashboard</button></a>
        <button class="nav-btn login-btn " id="logoutBtn" onclick="window.location.href='logout.html'">Log out</button>

    </div>
    
    <script>
      // Function to update the navbar based on user auth status
      const user = localStorage.getItem("userCredential");
      const authButtons = document.getElementById("authButtons");
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');
        document.addEventListener('DOMContentLoaded', function () {
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const dashboard = document.getElementById('dashboard');
    const logoutBtn = document.getElementById('logoutBtn');

    function checkAuth() {
      const isLoggedIn = sessionStorage.getItem('isLoggedIn');
      const storedEmail = sessionStorage.getItem('userEmail');

      if (isLoggedIn) {
        loginBtn.style.display = 'none';
        signupBtn.style.display = 'none';
        dashboard.style.display = 'inline-block';  // Make sure dashboard button is visible
        logoutBtn.style.display = 'inline-block';  // Make sure logout button is visible
      } else {
        logoutBtn.style.display = 'none';
        dashboard.style.display = 'none';
        loginBtn.style.display = 'inline-block';
        signupBtn.style.display = 'inlink-block';
      }
    }

    checkAuth();  // Call checkAuth to update button visibility
    
    logoutBtn.addEventListener('click', function () {
      sessionStorage.removeItem('isLoggedIn');
      sessionStorage.removeItem('userEmail');
      checkAuth();
      window.location.reload();
    });
   });   
      
    </script>
    </nav>
    <div class="sidebar">
        <div><a href="index.html" class="logo">Ehsaas<span>.</span></a></div>
      
    </div>
    <br/>
    <br/>
    <div class="main-content">
      <div class="header">
        <br/>
        <br/><br/>
        <h1 class="page-title">Sleep Insights</h1>
        <div class="toggle-container">
          <span class="toggle-label">Night Mode</span>
          <label class="toggle">
            <input type="checkbox" id="nightToggle">
            <span class="slider"></span>
          </label>
        </div>
      </div>
      
      <div class="dashboard-grid">
        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-title">Average Sleep Duration</span>
            <div class="stat-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path>
              </svg>
            </div>
          </div>
          <div class="stat-value">0.0h</div>
          <div class="stat-description">Last 7 days</div>
          <div class="progress-container">
            <div class="progress-bar" style="width: 85%;"></div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-title">Sleep Quality</span>
            <div class="stat-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
              </svg>
            </div>
          </div>
          <div class="stat-value">00<span style="font-size: 24px;">%</span></div>
          <div class="stat-description">Last night</div>
          <div class="progress-container">
            <div class="progress-bar" style="width: 86%;"></div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-header">
            <span class="stat-title">Sleep Goal Progress</span>
            <div class="stat-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
            </div>
          </div>
          <div class="stat-value">00<span style="font-size: 24px;">%</span></div>
          <div class="stat-description">Goal: 8 hours daily</div>
          <div class="progress-container">
            <div class="progress-bar" style="width: 90%;"></div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Sleep Pattern</h2>
          <span class="card-action">View Details</span>
        </div>
        <div class="sleep-chart">
          <img src="./sleep_pics/Breathing.jpg" alt="Sleep pattern chart" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
        </div>
        <div class="sleep-schedule">
          <div class="schedule-item">
            <span class="day">Mon</span>
            <span class="time-pill">11:30 PM</span>
          </div>
          <div class="schedule-item">
            <span class="day">Tue</span>
            <span class="time-pill">11:45 PM</span>
          </div>
          <div class="schedule-item">
            <span class="day">Wed</span>
            <span class="time-pill">10:30 PM</span>
          </div>
          <div class="schedule-item">
            <span class="day">Thu</span>
            <span class="time-pill">11:15 PM</span>
          </div>
          <div class="schedule-item">
            <span class="day">Fri</span>
            <span class="time-pill">12:00 AM</span>
          </div>
          <div class="schedule-item">
            <span class="day">Sat</span>
            <span class="time-pill">11:30 PM</span>
          </div>
          <div class="schedule-item">
            <span class="day">Sun</span>
            <span class="time-pill">10:45 PM</span>
          </div>
        </div>
        <button class="button" style="margin-top: 20px;">Track Sleep Now</button>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Sleep Recommendations</h2>
     
        </div>
        <div class="recommendation-item">
          <h3 class="recommendation-title">Consistent Sleep Schedule</h3>
          <p class="recommendation-description">Try to go to bed and wake up at the same time every day, even on weekends. This helps regulate your body's internal clock.</p>
        </div>
        <div class="recommendation-item">
          <h3 class="recommendation-title">Create a Relaxing Bedtime Routine</h3>
          <p class="recommendation-description">Engage in calming activities before bed, such as reading, gentle stretching, or meditation to signal to your body that it's time to wind down.</p>
        </div>
        <div class="recommendation-item">
          <h3 class="recommendation-title">Optimize Your Sleep Environment</h3>
          <p class="recommendation-description">Keep your bedroom cool, dark, and quiet for optimal sleep quality. Consider using earplugs, an eye mask, or white noise machine if needed.</p>
        </div>
        <button class="button" style="margin-top: 10px;">Get Personalized Plan</button>
      </div>
    </div>
  </div>

  <script>
// â€”â€”â€”â€”â€”â€”â€”â€” Main App State â€”â€”â€”â€”â€”â€”â€”â€”
let settings = load('sleepSettings', {});
let sleepLog = load('sleepLog', []);
let currentSessionStart = load('currentSessionStart', null);
let sessionInterval = null;
let currentUser = load('currentUser', null);
let users = load('users', {});

// â€”â€”â€”â€”â€”â€”â€”â€” Storage Helpers â€”â€”â€”â€”â€”â€”â€”â€”
function save(key, val) { 
  localStorage.setItem(key, JSON.stringify(val)); 
}

function load(key, def) {
  const d = localStorage.getItem(key);
  return d ? JSON.parse(d) : def;
}

function saveUserData() {
  if (!currentUser) return;
  
  // Save current user's data
  users[currentUser] = {
    settings: settings,
    sleepLog: sleepLog,
    currentSessionStart: currentSessionStart
  };
  
  save('users', users);
}

function loadUserData(username) {
  if (!username || !users[username]) return false;
  
  // Load user data
  const userData = users[username];
  settings = userData.settings || {};
  sleepLog = userData.sleepLog || [];
  currentSessionStart = userData.currentSessionStart;
  
  // Update UI with loaded data
  updateDashboard();
  updateSchedule();
  updateUIForSession(!!currentSessionStart);
  if (currentSessionStart) scheduleLiveUpdates();
  
  return true;
}

function ask(promptText, validator) {
  let v;
  do {
    v = prompt(promptText);
  } while (v === null || (validator && !validator(v)));
  return v;
}

// â€”â€”â€”â€”â€”â€”â€”â€” User Management â€”â€”â€”â€”â€”â€”â€”â€”
function userLogin() {
  const username = ask("Enter your username:", v => v && v.trim() !== "");
  
  // Check if user exists
  if (users[username]) {
    // Existing user
    currentUser = username;
    save('currentUser', currentUser);
    loadUserData(username);
    updateUserDisplay();
    alert(`Welcome back, ${username}!`);
  } else {
    // New user
    currentUser = username;
    save('currentUser', currentUser);
    
    // Initialize empty data for new user
    settings = {};
    sleepLog = [];
    currentSessionStart = null;
    saveUserData();
    
    updateUserDisplay();
    alert(`Welcome, ${username}! Please set up your sleep goals.`);
    setSettings();
  }
}

function userLogout() {
  // Save current data before logout
  saveUserData();
  
  // Clear current user
  currentUser = null;
  save('currentUser', null);
  
  // Reset to empty state
  settings = {};
  sleepLog = [];
  currentSessionStart = null;
  updateDashboard();
  updateSchedule();
  updateUIForSession(false);
  updateUserDisplay();
  
  alert("You have been logged out.");
}

function updateUserDisplay() {
  const userDisplay = document.getElementById('currentUserDisplay');
  if (userDisplay) {
    userDisplay.textContent = currentUser ? currentUser : "Guest";
  }
  
  // Update login/logout button
  const loginBtn = document.getElementById('loginBtn');
  if (loginBtn) {
    loginBtn.textContent = currentUser ? "Logout" : "Login";
  }
}

// â€”â€”â€”â€”â€”â€”â€”â€” User Settings â€”â€”â€”â€”â€”â€”â€”â€”
function setSettings() {
  if (!currentUser) {
    alert("Please login first!");
    userLogin();
    if (!currentUser) return;
  }
  
  // Get sleep goal
  settings.goalHours = Number(ask("Enter your daily sleep goal in hours (e.g. 8)", 
    v => !isNaN(v) && Number(v) > 0));
  
  // Get reminders
  settings.bedReminder = ask("Set your bedtime reminder (HH:MM, 24h)", 
    v => /^\d\d:\d\d$/.test(v));
  settings.wakeReminder = ask("Set your wake-up reminder (HH:MM, 24h)", 
    v => /^\d\d:\d\d$/.test(v));
  
  saveUserData();
  Notification.requestPermission();
  alert(
    `Settings saved:\n` +
    `â€¢ Goal: ${settings.goalHours} h\n` +
    `â€¢ Bedtime reminder: ${settings.bedReminder}\n` +
    `â€¢ Wake-up reminder: ${settings.wakeReminder}`
  );
  scheduleReminders();
  updateDashboard();
}

// â€”â€”â€”â€”â€”â€”â€”â€” Daily Notifications â€”â€”â€”â€”â€”â€”â€”â€”
function scheduleReminders() {
  if (!settings.bedReminder || !settings.wakeReminder) return;
  setInterval(() => {
    const now = new Date().toTimeString().slice(0,5);
    if (now === settings.bedReminder || now === settings.wakeReminder) {
      new Notification(
        now === settings.bedReminder
          ? "ðŸ›ï¸ Time for bed!"
          : "â° Time to wake up!"
      );
    }
  }, 30000);
}

// â€”â€”â€”â€”â€”â€”â€”â€” Sleep Session Management â€”â€”â€”â€”â€”â€”â€”â€”
function startSession() {
  if (!currentUser) {
    alert("Please login first!");
    userLogin();
    if (!currentUser) return;
  }
  
  currentSessionStart = new Date().toISOString();
  saveUserData();
  updateUIForSession(true);
  scheduleLiveUpdates();
}

function stopSession() {
  const start = new Date(currentSessionStart);
  const now = new Date();
  const hrs = Math.round(((now - start) / 3600000) * 10) / 10;
  
  // Ask for quality rating
  const qual = Number(ask("Rate your sleep quality (0-100)%", 
    v => !isNaN(v) && Number(v) >= 0 && Number(v) <= 100));
  
  // Create and save new sleep entry
  const entry = {
    date: start.toLocaleDateString('en-US', {weekday: 'short'}),
    bedtime: start.toTimeString().slice(0,5),
    waketime: now.toTimeString().slice(0,5),
    hours: hrs,
    quality: qual
  };
  
  // Add to beginning of log and limit to 7 days
  sleepLog.unshift(entry);
  if (sleepLog.length > 7) sleepLog.pop();
  
  // Clear session data
  currentSessionStart = null;
  saveUserData();
  clearInterval(sessionInterval);
  
  // Update UI
  updateUIForSession(false);
  updateDashboard();
  updateSchedule();
  
  alert(`Logged ${hrs} h, quality ${qual}%`);
}

// â€”â€”â€”â€”â€”â€”â€”â€” Export/Import Data â€”â€”â€”â€”â€”â€”â€”â€”
function exportData() {
  if (!currentUser) {
    alert("Please login first!");
    return;
  }
  
  // Save current data before exporting
  saveUserData();
  
  // Get user data
  const userData = users[currentUser];
  if (!userData) {
    alert("No data to export!");
    return;
  }
  
  // Create export object
  const exportData = {
    user: currentUser,
    data: userData,
    exportDate: new Date().toISOString()
  };
  
  // Convert to string
  const dataStr = JSON.stringify(exportData);
  
  // Create download link
  const a = document.createElement('a');
  const blob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  a.href = url;
  a.download = `ehsaas_sleep_data_${currentUser}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function importData() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'application/json';
  
  fileInput.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const importData = JSON.parse(e.target.result);
        if (!importData.user || !importData.data) {
          alert("Invalid data format!");
          return;
        }
        
        // Add imported user
        users[importData.user] = importData.data;
        save('users', users);
        
        // Switch to imported user
        currentUser = importData.user;
        save('currentUser', currentUser);
        loadUserData(currentUser);
        updateUserDisplay();
        
        alert(`Data imported successfully for ${importData.user}!`);
      } catch (error) {
        alert("Error importing data: " + error.message);
      }
    };
    
    reader.readAsText(file);
  };
  
  fileInput.click();
}

// â€”â€”â€”â€”â€”â€”â€”â€” UI Update Functions â€”â€”â€”â€”â€”â€”â€”â€”
function updateDashboard() {
  if (!settings.goalHours) return;
  
  // Get entries including provisional current session
  let entries = [...sleepLog];
  let provisional = null;
  
  if (currentSessionStart) {
    const start = new Date(currentSessionStart);
    const now = new Date();
    const hrs = Math.round(((now - start) / 3600000) * 10) / 10;
    
    // Estimate quality based on hours/goal ratio (only for display until actual rating)
    const q = Math.min(Math.round((hrs / settings.goalHours) * 100), 100);
    
    provisional = {
      date: start.toLocaleDateString('en-US', {weekday: 'short'}),
      bedtime: start.toTimeString().slice(0,5),
      hours: hrs,
      quality: q
    };
    entries.unshift(provisional);
  }
  
  const used = entries.slice(0, 7);
  
  // 1) Average Sleep Duration
  const avg = used.length > 0 
    ? Math.round((used.reduce((sum, e) => sum + e.hours, 0) / used.length) * 10) / 10 
    : 0;
    
  document.querySelector('.stat-card:nth-child(1) .stat-value').innerText = avg + 'h';
  document.querySelector('.stat-card:nth-child(1) .progress-bar')
    .style.width = Math.min(avg / settings.goalHours * 100, 100) + '%';
  
  // 2) Sleep Quality (last entry)
  const lastQ = used.length > 0 ? used[0].quality : 0;
  
  document.querySelector('.stat-card:nth-child(2) .stat-value')
    .innerHTML = lastQ + '<span style="font-size:24px">%</span>';
  document.querySelector('.stat-card:nth-child(2) .progress-bar')
    .style.width = lastQ + '%';
  
  // 3) Sleep Goal Progress
  const prog = Math.round(avg / settings.goalHours * 100);
  document.querySelector('.stat-card:nth-child(3) .stat-value')
    .innerHTML = prog + '<span style="font-size:24px">%</span>';
  document.querySelector('.stat-card:nth-child(3) .progress-bar')
    .style.width = Math.min(prog, 100) + '%';
}

function updateSchedule() {
  const items = document.querySelectorAll('.sleep-schedule .schedule-item');
  
  // Get entries including provisional current session
  let entries = [...sleepLog];
  if (currentSessionStart) {
    const start = new Date(currentSessionStart);
    entries.unshift({
      date: start.toLocaleDateString('en-US', {weekday: 'short'}),
      bedtime: start.toTimeString().slice(0,5)
    });
  }
  
  // Update schedule display
  items.forEach((el, i) => {
    const e = entries[i];
    if (e) {
      el.querySelector('.day').innerText = e.date;
      el.querySelector('.time-pill').innerText = e.bedtime;
    } else {
      el.querySelector('.day').innerText = '--';
      el.querySelector('.time-pill').innerText = '--:--';
    }
  });
}

function updateUIForSession(running) {
  const btn = Array.from(document.querySelectorAll('.button'))
    .find(b => b.innerText.includes('Track'));
    
  if (btn) {
    btn.innerText = running ? 'Stop Tracking Sleep' : 'Track Sleep Now';
  }
}

function scheduleLiveUpdates() {
  if (sessionInterval) clearInterval(sessionInterval);
  updateDashboard(); 
  updateSchedule();
  sessionInterval = setInterval(() => {
    updateDashboard(); 
    updateSchedule();
  }, 60000);
}

// â€”â€”â€”â€”â€”â€”â€”â€” Initialize App â€”â€”â€”â€”â€”â€”â€”â€”
document.addEventListener('DOMContentLoaded', () => {
  // Create user interface elements
  createUserInterface();
  
  // Set up event listeners for buttons
  document.querySelectorAll('.button').forEach(btn => {
    if (btn.innerText.includes('Track')) {
      btn.addEventListener('click', () => {
        currentSessionStart ? stopSession() : startSession();
      });
    }
    if (btn.innerText.includes('Personalized')) {
      btn.addEventListener('click', setSettings);
    }
  });
  
  // Login button
  const loginBtn = document.getElementById('loginBtn');
  if (loginBtn) {
    loginBtn.addEventListener('click', () => {
      currentUser ? userLogout() : userLogin();
    });
  }
  
  // Export button
  const exportBtn = document.getElementById('exportBtn');
  if (exportBtn) {
    exportBtn.addEventListener('click', exportData);
  }
  
  // Import button
  const importBtn = document.getElementById('importBtn');
  if (importBtn) {
    importBtn.addEventListener('click', importData);
  }
  
  // Night mode toggle
  const nightToggle = document.getElementById('nightToggle');
  const container = document.getElementById('container');
  const sun = document.getElementById('sun');
  const moon = document.getElementById('moon');
  
  // Show sun animation on load
  setTimeout(() => {
    sun.classList.add('sun-visible');
  }, 500);
  
  nightToggle.addEventListener('change', function() {
    if (this.checked) {
      // Switch to night mode
      container.classList.add('night-mode');
      sun.classList.remove('sun-visible');
      setTimeout(() => {
        moon.classList.add('moon-visible');
      }, 500);
    } else {
      // Switch to day mode
      container.classList.remove('night-mode');
      moon.classList.remove('moon-visible');
      setTimeout(() => {
        sun.classList.add('sun-visible');
      }, 500);
    }
  });
  
  // Create sun rays
  const sunRays = document.getElementById('sunRays');
  for (let i = 0; i < 12; i++) {
    const ray = document.createElement('div');
    ray.className = 'ray';
    ray.style.transform = `rotate(${i * 30}deg) translateX(50px)`;
    sunRays.appendChild(ray);
  }
  
  // Create stars for night mode
  const stars = document.getElementById('stars');
  for (let i = 0; i < 100; i++) {
    const star = document.createElement('div');
    star.className = 'star';
    star.style.top = `${Math.random() * 100}%`;
    star.style.left = `${Math.random() * 100}%`;
    star.style.animationDelay = `${Math.random() * 5}s`;
    star.style.width = `${Math.random() * 2 + 1}px`;
    star.style.height = star.style.width;
    stars.appendChild(star);
  }
  
  // Auto login if user exists
  if (currentUser) {
    loadUserData(currentUser);
    updateUserDisplay();
  }
});

function createUserInterface() {
  // Create user management panel
  const header = document.querySelector('.header');
  if (header) {
    const userPanel = document.createElement('div');
    userPanel.className = 'user-panel';
    userPanel.style = 'display: flex; align-items: center; margin-right: 20px;';
    
    const userDisplay = document.createElement('span');
    userDisplay.id = 'currentUserDisplay';
    userDisplay.textContent = currentUser || "Guest";
    userDisplay.style = 'margin-right: 10px; font-weight: 500;';
    
    const loginBtn = document.createElement('button');
    loginBtn.id = 'loginBtn';
    loginBtn.className = 'button';
    loginBtn.textContent = currentUser ? "Logout" : "Login";
    loginBtn.style = 'padding: 6px 12px; font-size: 14px;';
    
    userPanel.appendChild(userDisplay);
    userPanel.appendChild(loginBtn);
    header.insertBefore(userPanel, header.firstChild);
  }
  
  // Create data management buttons
  const actionSection = document.createElement('div');
  actionSection.className = 'card';
  actionSection.innerHTML = `
    <div class="card-header">
      <h2 class="card-title">Data Management</h2>
    </div>
    <div style="display: flex; gap: 10px;">
      <button id="exportBtn" class="button">Export Data</button>
      <button id="importBtn" class="button">Import Data</button>
    </div>
  `;
  
  const mainContent = document.querySelector('.main-content');
  if (mainContent) {
    mainContent.appendChild(actionSection);
  }
}
  
</script>
</body>
</html>